# 1.1.1 Infrastructure as Code

过去很长一段时间内,配置基础设施都是一项漫长的,容器出错的,对于工程师经验要求非常高的工作.
不过现在,有了更先进的云基础服务,可以通过web来完成之前需要手工完成的所有配置.
但是,通常我们发现通过web化依然不是好的主意:
* 按钮点击依然会出错(人类犯错误,基础原理不太懂...)
* 没有版本化控制(没有存储到git中)
* 仍然很多重复操作(不可复用)
* 操作不可见(不清楚web操作是否有效或者是否有风险)

而配置环境的所有工作,先是开发环境,集成环境,QA测试环境,灰度,生产环境,仍然乏味的重复.
因此: 新的方式,基础设置即代码 应运而生.

作为最佳实践,基础设施即代码要求只要是配置计算资源的工作,都必须通过代码完成,而且可以通过版本控制来快速配置和改进.
计算资源则包含了正确运行应用程序所需要的一切资源: 计算,存储,网络,数据库等等,所以故名 "基础设施即代码"

而这意味着我们不会通过web或者手工来操作基础设置,取而代之的是: 
* Terraform里用代码表述基础设施状态
* 通过git版本控制代码
* 通过正式的ITIL服务管理流程来反馈
* 测试代码
* 执行并提供资源

### Why Terraform ?
为什么是Terraform而不是chef, salt,ansible等?
事实上,人们进行了大量的讨论,而terraform具体一些特性则使得它在某些领域更棒: 
* 跨平台
* 简单使其学习成本很低
* 自动化管理基础结构

当然这个领域发展迅猛,不过传统上Terraform这样的东西呗用于配置基础设施,而ansible Salt等则用来配置它.
可以简单理解为Terraform创建基础,而Salt在它之上完成其他工作,根据需求来部署应用程序等.

![](https://ws3.sinaimg.cn/large/006tNc79ly1fzffusziwjj30ee08q74i.jpg)

换句话说，你能使用Terraform来创建VM，然后使用Salt配置服务器或是部署你的应用程序。

### Terraform是什么

Terraform是一个安全、高效地部署、更改、版本化基础设施和应用程序的开源工具，可以用来管理多层次的资源。从上层的软件配置到底层的网络、甚至云基础架构系统配置都可以使用 Terraform 统一进行安全高效的预先配置和管理。

HashiCorp Terraform 是一个IT基础架构自动化编排工具，可以用代码来管理维护 IT 资源。Terraform的命令行接口 (CLI) 提供一种简单机制，用于将配置文件部署到基础设施和云上.它编写了描述资源拓扑的配置文件中的基础结构，例如虚拟机、存储帐户和网络接口。Terraform 的命令行接口（CLI）提供一种简单机制，用于将配置文件部署到对应的计算资源上并对其进行版本控制。
Terraform是一个高度可扩展的工具，通过 Provider 来支持新的基础架构。您可以使用Terraform来创建、修改、删除ECS、VPC、RDS、SLB等多种资源。

#### 主要特性

* 基础设施即代码
将基础架构使用配置语法进行描述，这可以让数据中心的构建计划可以像其他代码一样进行版本化和追踪。

* 执行计划
Terraform 有一个规划步骤，它生成一个执行计划。执行计划显示当您调用应用程序时 Terraform 将执行的操作。使用这个功能可以保证操作基础设施时不发生意外

* 资源视图
Terraform 创建了一个所有资源的视图。这使得 Terraform 可以并行化没有依赖的创建与修改。
因此，Terraform 可以高效地构建基础架构。操作人员也能更加了解环境的结构。

* 变更自动化
Terraform 会自动的分析什么是需要修改的，从而避免了许多可能的人为错误。


#### 与其他类似工具的区别

主要的基础设置即代码工具主要有: 
* Chef：https://www.chef.io
* Puppet：https://puppet.com
* Ansible：https://www.ansible.com
* SaltStack：https://saltstack.com
* CloudFormation：https://aws.amazon.com/cn/cloudformation

![](https://ws2.sinaimg.cn/large/006tNc79ly1fzfghzi8vrj30sh0ai42n.jpg)
##### 配管管理和编排工具

配置工具: Chef、Puppet、Ansible、SaltStack 都可以称为配置管理工具，这些工具的主要目标是在已经存在的机器上安装和管理软件。
编排工具: Terraform 和 CloudFormation 可以称为编排工具，更注重于数据中心以及相关服务的高级抽象。他们的工作重点是创建资源并且引导进行初始化。

依照当前的趋势来看,配置工具的重要性可能会降低,而编排工具的重要性可能会提高.为什么?

事实上是因为"容器或者镜像"的大量应用而导致的不可变部署.你的部署单元从最初的代码变成现在的VM或者docker容器.因此:
* 不用去将代码部署到静态VM中,而是部署已经包含了已编译代码的VM.
* 不会选择更改VM的配置方式,而是部署新的VM.
* 不必去修复生产的机器,直接起一个新的实例.
* 不必在开发和生产环境部署不同的VM,因为他们是相同的.

Devops理念要求将配置和代码做分离,譬如你肯定不希望每次替换数据库密码时都要重新部署mysql.相反,应用程序应该从外部配置中心获取对应的配置信息.

因此,随着不可变部署的兴起, 配置管理工具扮演的角色将会降低,原因是只需要使用一个或者多个配置中心并将其作为扩展的一部分进行多次部署就可以.
所有环境使用完全相同的容器,避免出现配置偏差,出现问题,简单回滚即可.

如果你想查看日志,无需登录服务器或者容器查看日志,而是通过统一的日志收集程序获取,因此可以完全禁止某些远程访问.提供更强的安全性.

全自动的DevOps应该始于配置运行代码所需的计算资源,实现目标的最佳实践也是通过不可变部署.

